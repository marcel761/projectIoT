<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kontrol Lampu MQTT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Poppins',sans-serif;
}

body{
  height:100vh;
  background:radial-gradient(circle at top,#042a52,#020b14);
  color:white;
  overflow:hidden; /* ‚¨ÖÔ∏è penting */
}

/* ===== HEADER ===== */
header{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:600;
  background:rgba(15,30,60,.6);
  backdrop-filter:blur(12px);
  border-bottom:1px solid rgba(0,255,255,.2);
  z-index:10;
}

.hamburger{
  position:absolute;
  left:15px;
  cursor:pointer;
  width:28px;
  height:22px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.hamburger span{
  width:100%;
  height:3px;
  background:#00eaff;
  border-radius:5px;
}

/* ===== SIDEBAR ===== */
.sidebar{
  position:fixed;
  top:0;
  left:-250px;
  width:230px;
  height:100vh;
  background:rgba(3,17,30,.95);
  padding-top:70px;
  transition:.35s;
  z-index:11;
}
.sidebar a{
  display:block;
  padding:14px 20px;
  color:#00eaff;
  text-decoration:none;
}

/* ===== OVERLAY ===== */
.overlay{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.4);
  opacity:0;
  visibility:hidden;
  transition:.3s;
  z-index:9;
}
.overlay.active{
  opacity:1;
  visibility:visible;
}

/* ===== MAIN (SCROLL AREA) ===== */
main{
  position:fixed;
  top:60px;               /* tinggi header */
  bottom:45px;            /* tinggi footer */
  left:0;
  right:0;
  padding:25px;
  overflow-y:auto;        /* ‚¨ÖÔ∏è hanya main yang scroll */
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}

/* ===== FOOTER ===== */
footer{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:45px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  opacity:.75;
  background:rgba(15,30,60,.6);
  z-index:10;
}

/* ===== KOMPONEN ===== */
.status-box{
  font-size:16px;
  font-weight:600;
  padding:10px 20px;
  border-radius:8px;
  border:2px solid #00eaff;
  margin-bottom:20px;
  color:#00eaff;
}

.btn-control{
  width:160px;
  padding:12px;
  margin:10px;
  font-size:16px;
  font-weight:700;
  border-radius:10px;
  border:2px solid #00eaff;
  background:rgba(0,255,255,.08);
  color:#00eaff;
  cursor:pointer;
}

.lamp-img{
  width:160px;
  margin-bottom:20px;
  transition:.3s;
}

.lamp-on{
  filter:drop-shadow(0 0 15px #ffeb3b) brightness(1.3);
}

/* ===== STATUS ESP ===== */
.esp-online{
  border-color:#00ff88;
  color:#00ff88;
}

.esp-offline{
  border-color:#ff5252;
  color:#ff5252;
  opacity:.8;
}

.wifi-icon{
  position:absolute;
  right:15px;
  cursor:pointer;
  font-size:22px;
  color:#00eaff;
  transition:.3s;
}

.wifi-icon:hover{
  color:#00ff88;
  transform:scale(1.2);
}

/* ===== MODAL ===== */
.modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}

.modal-box{
  background:rgba(15,30,60,.95);
  padding:25px 30px;
  border-radius:14px;
  text-align:center;
  width:280px;
  border:2px solid #00eaff;
  animation:pop .3s ease;
}

.modal-box h3{
  margin-bottom:10px;
  color:#00eaff;
}

.modal-box p{
  font-size:14px;
  opacity:.85;
  margin-bottom:20px;
}

.modal-btn{
  display:flex;
  justify-content:space-between;
}

.modal-btn button{
  flex:1;
  margin:0 5px;
  padding:10px;
  border-radius:8px;
  border:none;
  font-weight:600;
  cursor:pointer;
}

.modal-btn .danger{
  background:#ff5252;
  color:white;
}

.modal-btn button:not(.danger){
  background:#444;
  color:white;
}

@keyframes pop{
  from{transform:scale(.8);opacity:0}
  to{transform:scale(1);opacity:1}
}


</style>
</head>

<body>
<header>
  <div class="hamburger" onclick="toggleMenu()">
    <span></span><span></span><span></span>
  </div>

  Kontrol Lampu

  <!-- ICON WIFI -->
  <div class="wifi-icon" onclick="resetWiFi()" title="Ganti WiFi">
    üì∂
  </div>
</header>


<div class="sidebar" id="sidebar">
<a href="#">Kontrol Lampu</a>
</div>
<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<!-- ===== WIFI RESET MODAL ===== -->
<div id="wifiModal" class="modal">
  <div class="modal-box">
    <h3>Ganti WiFi ESP?</h3>
    <p>ESP akan masuk mode konfigurasi WiFi.</p>
    <div class="modal-btn">
      <button onclick="closeWifiModal()">Batal</button>
      <button class="danger" onclick="confirmResetWiFi()">Lanjut</button>
    </div>
  </div>
</div>

<main>
<img id="lampIcon" class="lamp-img" src="lampu.png">
<div id="espStatus" class="status-box">
  ESP: Mengecek koneksi...
</div>
<div id="statusLampu" class="status-box">Status: Menghubungkan MQTT...</div>
<div id="modeLampu" class="status-box">Mode: MANUAL</div>
<button class="btn-control" onclick="lampuOn()">NYALAKAN</button>
<button class="btn-control" onclick="lampuOff()">MATIKAN</button>
<button class="btn-control" onclick="setAuto()">MODE AUTO</button>

</main>

<footer>¬© 2025 Smart IoT MQTT</footer>

<script>
function toggleMenu(){
 let s=document.getElementById('sidebar');
 let o=document.getElementById('overlay');
 if(s.style.left==='0px'){s.style.left='-250px';o.classList.remove('active')}else{s.style.left='0px';o.classList.add('active')}
}

// ================= MQTT =================
// Topic:
// iot/lampu/kontrol  -> ON / OFF
// iot/lampu/mode     -> AUTO
// iot/lampu/status   -> ON / OFF
// iot/lampu/modeStatus -> MANUAL / AUTO

const broker = 'wss://broker.hivemq.com:8884/mqtt';
const client = mqtt.connect(broker);

client.on('connect',()=>{
 document.getElementById('statusLampu').innerText='Status: MQTT Terhubung';

 client.subscribe('iot/lampu/status');
 client.subscribe('iot/lampu/modeStatus');
 client.subscribe('iot/lampu/autoStatus');
 client.subscribe('iot/lampu/espStatus');

 // minta status awal
 client.publish('iot/lampu/requestStatus','REQ');
});



client.on('message',(topic,message)=>{
 const msg = message.toString();

 if(topic === 'iot/lampu/espStatus'){
  const espBox = document.getElementById('espStatus');

  if(msg === 'ONLINE'){
    espBox.innerText = 'ESP: ONLINE';
    espBox.classList.remove('esp-offline');
    espBox.classList.add('esp-online');

    enableButtons(true);

    // minta status lampu setelah ESP online
    client.publish('iot/lampu/requestStatus','REQ');
  }

  if(msg === 'OFFLINE'){
    espBox.innerText = 'ESP: OFFLINE';
    espBox.classList.remove('esp-online');
    espBox.classList.add('esp-offline');

    document.getElementById('statusLampu').innerText =
      'Status: ESP tidak terhubung';

    document.getElementById('lampIcon').classList.remove('lamp-on');

    enableButtons(false);
  }
}


 if(topic==='iot/lampu/status'){
  if(msg==='ON'){
   document.getElementById('statusLampu').innerText='Status: Lampu Menyala';
   document.getElementById('lampIcon').classList.add('lamp-on');
  }
  if(msg==='OFF'){
   document.getElementById('statusLampu').innerText='Status: Lampu Mati';
   document.getElementById('lampIcon').classList.remove('lamp-on');
  }
 }

 if(topic==='iot/lampu/modeStatus'){
  document.getElementById('modeLampu').innerText='Mode: '+msg;
 }
 if(topic === 'iot/lampu/autoStatus'){
  if(msg === 'GELAP_ON'){
    document.getElementById('statusLampu').innerText =
      'Status: Kondisi gelap, lampu menyala';
    document.getElementById('lampIcon').classList.add('lamp-on');
  }

  if(msg === 'TERANG_OFF'){
    document.getElementById('statusLampu').innerText =
      'Status: Kondisi terang, lampu mati';
    document.getElementById('lampIcon').classList.remove('lamp-on');
  }
   // ===== PIR (DISAMAKAN DENGAN LDR) =====
  if(msg === 'PIR_ON'){
    document.getElementById('statusLampu').innerText =
      'Status: Ada gerakan, lampu menyala';
    document.getElementById('lampIcon').classList.add('lamp-on');
  }

  if(msg === 'PIR_TIMEOUT_OFF'){
    document.getElementById('statusLampu').innerText =
      'Status: Tidak ada gerakan (30 detik), lampu mati';
    document.getElementById('lampIcon').classList.remove('lamp-on');
  }
}
});

function lampuOn(){
 client.publish('iot/lampu/kontrol','ON');
 document.getElementById('modeLampu').innerText='Mode: MANUAL';
}
function lampuOff(){
 client.publish('iot/lampu/kontrol','OFF');
 document.getElementById('modeLampu').innerText='Mode: MANUAL';
}
function setAuto(){
 client.publish('iot/lampu/mode','AUTO');

 // ‚¨áÔ∏è minta kondisi langsung (biar status update)
 setTimeout(()=>{
   client.publish('iot/lampu/requestStatus','REQ');
 },300);
}

function enableButtons(enable){
  document.querySelectorAll('.btn-control').forEach(btn=>{
    btn.disabled = !enable;
    btn.style.opacity = enable ? '1' : '0.4';
    btn.style.cursor = enable ? 'pointer' : 'not-allowed';
  });
}
enableButtons(false);

function resetWiFi(){
  document.getElementById('wifiModal').style.display = 'flex';
}

function closeWifiModal(){
  document.getElementById('wifiModal').style.display = 'none';
}

function confirmResetWiFi(){
  client.publish('iot/lampu/resetWiFi','RESET');

  document.getElementById('statusLampu').innerText =
    'Status: Mengganti WiFi...';

  document.getElementById('espStatus').innerText =
    'ESP: RESTARTING';

  closeWifiModal();
}

</script>
</body>
</html>
